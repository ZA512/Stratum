generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // Connection URL is configured in prisma.config.ts (Prisma ORM v7+)
  schemas  = ["stratum"]
}

enum MembershipStatus {
  INVITED
  ACTIVE
  SUSPENDED

  @@schema("stratum")
}


enum ColumnBehaviorKey {
  BACKLOG
  IN_PROGRESS
  BLOCKED
  DONE
  CUSTOM

  @@schema("stratum")
}

enum Priority {
  NONE
  CRITICAL
  HIGH
  MEDIUM
  LOW
  LOWEST

  @@schema("stratum")
}

enum Effort {
  UNDER2MIN
  XS
  S
  M
  L
  XL
  XXL

  @@schema("stratum")
}

enum ActivityType {
  SHARE_INVITE_CREATED
  SHARE_INVITE_ACCEPTED
  SHARE_INVITE_DECLINED
  SHARE_INVITE_EXPIRED
  SHARE_LINK_REMOVED
  KANBAN_SOFT_DELETED
  KANBAN_RESTORED
  KANBAN_MOVED
  KANBAN_MOVE_REFUSED
  KANBAN_BECAME_SHARED
  NODE_CREATED
  NODE_UPDATED
  NODE_MOVED
  NODE_DELETED
  NODE_ARCHIVED
  NODE_RESTORED
  NODE_SNOOZED
  NODE_UNSNOOZED
  COLLABORATOR_ADDED
  COLLABORATOR_REMOVED
  INVITATION_SENT
  INVITATION_ACCEPTED
  INVITATION_DECLINED
  COMMENT_ADDED
  DESCRIPTION_UPDATED
  TITLE_UPDATED
  DUE_DATE_UPDATED
  PRIORITY_UPDATED
  EFFORT_UPDATED
  TAGS_UPDATED
  ASSIGNEES_UPDATED
  MOVED_TO_BOARD
  PROGRESS_UPDATED
  BLOCKED_STATUS_CHANGED
  RACI_UPDATED

  @@schema("stratum")
}

enum QuickNoteType {
  NOTE
  DONE
  WAITING

  @@schema("stratum")
}

enum NodeKind {
  PROJECT
  NEXT_ACTION
  WAITING_FOR
  NOTE
  REFERENCE
  MILESTONE
  DECISION
  RISK
  BLOCKER

  @@schema("stratum")
}

enum WorkspaceAiLevel {
  OFF
  LIGHT
  EMBEDDING
  HEAVY

  @@schema("stratum")
}

enum EventActorType {
  USER
  AGENT
  SYSTEM

  @@schema("stratum")
}

enum EventSource {
  API
  AGENT
  SCHEDULER

  @@schema("stratum")
}

enum ProposalStatus {
  DRAFT
  VALIDATED
  APPROVED
  REJECTED
  APPLIED
  ROLLED_BACK

  @@schema("stratum")
}

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  passwordHash    String?
  displayName     String
  locale          String        @default("en-US")
  avatarUrl       String?
  bio             String?
  preferences     Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  memberships     Membership[]
  assignedNodes   NodeAssignment[]
  comments        Comment[]
  refreshTokens    RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  invitationsSent  Invitation[] @relation("UserInvitations")
  settings        UserSettings?
  ownedBoards     Board[]       @relation("UserOwnedBoards")
  nodeShareInvitationsSent NodeShareInvitation[] @relation("NodeShareInvitationsSent")
  nodeShareInvitationsReceived NodeShareInvitation[] @relation("NodeShareInvitationsReceived")
  sharedNodePlacements SharedNodePlacement[]
  activityLogs    ActivityLog[]
  quickNotes      QuickNote[]

  @@schema("stratum")
}

model Team {
  id              String           @id @default(cuid())
  name            String
  slug            String?          @unique
  description     String?
  settings        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  memberships     Membership[]
  nodes           Node[]
  automationRules AutomationRule[]
  invitations     Invitation[]
  isPersonal      Boolean          @default(false)

  @@schema("stratum")
}

model Membership {
  id         String            @id @default(cuid())
  userId     String
  teamId     String
  title      String?
  status     MembershipStatus  @default(ACTIVE)
  metadata   Json?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  team       Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])

  @@schema("stratum")
}

model Node {
  id              String            @id @default(cuid())
  teamId          String
  workspaceId     String
  parentId        String?
  columnId        String?
  title           String
  description     String?           @db.Text
  shortId         Int               @unique @default(autoincrement())
  path            String
  depth           Int               @default(0)
  position        Float             @default(0)
  progress        Int               @default(0)
  priority        Priority          @default(NONE)
  effort          Effort?
  tags            String[]          @default([])
  blockedReason               String?           @db.Text
  blockedReminderEmails       String[]          @default([])
  blockedReminderIntervalDays Int?
  blockedReminderLastSentAt   DateTime?
  blockedExpectedUnblockAt    DateTime?
  blockedSince                DateTime?
  isBlockResolved             Boolean           @default(false)
  statusMetadata  Json?
  metadata        Json?
  dueAt           DateTime?
  startAt         DateTime?
  archivedAt      DateTime?
  createdById     String?
  kind            NodeKind          @default(NEXT_ACTION)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  team            Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  parent          Node?             @relation("NodeToNode", fields: [parentId], references: [id], onDelete: Cascade)
  children        Node[]            @relation("NodeToNode")
  board           Board?
  column          Column?           @relation(fields: [columnId], references: [id])
  assignments     NodeAssignment[]
  dependencies    Dependency[]      @relation("DependencyDependents")
  dependents      Dependency[]      @relation("DependencyDependencies")
  attachments     Attachment[]
  comments        Comment[]
  shareInvitations NodeShareInvitation[]
  sharedPlacements SharedNodePlacement[]
  activityLogs    ActivityLog[]

  @@index([workspaceId])
  @@index([workspaceId, kind, archivedAt])

  @@schema("stratum")
}

model Board {
  id              String            @id @default(cuid())
  nodeId          String            @unique
  layout          Json?
  themeOverride   Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ownerUserId     String?
  isPersonal      Boolean           @default(false)

  node            Node              @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  columns         Column[]
  dailySnapshots  BoardDailySnapshot[]
  owner           User?             @relation("UserOwnedBoards", fields: [ownerUserId], references: [id], onDelete: SetNull)
  quickNotes      QuickNote[]

  @@schema("stratum")
}

model Column {
  id              String             @id @default(cuid())
  boardId         String
  behaviorId      String
  name            String
  position        Int
  wipLimit        Int?
  slaConfig       Json?
  settings        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  board           Board              @relation(fields: [boardId], references: [id], onDelete: Cascade)
  behavior        ColumnBehavior     @relation(fields: [behaviorId], references: [id], onDelete: Restrict)
  nodes           Node[]
  sharedNodePlacements SharedNodePlacement[]

  @@schema("stratum")
}

model ColumnBehavior {
  id        String            @id @default(cuid())
  key       ColumnBehaviorKey
  label     String
  metadata  Json?
  color     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  columns   Column[]

  @@schema("stratum")
}

model NodeAssignment {
  id          String    @id @default(cuid())
  nodeId      String
  userId      String
  role        String?
  assignedAt  DateTime  @default(now())

  node        Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("stratum")
}

// Checklist & ChecklistItem supprim├®s (migration unifi├®e vers enfants)

model Dependency {
  id             String   @id @default(cuid())
  dependentId    String
  dependencyId   String
  type           String   @default("finish-to-start")
  lag            Int      @default(0)

  dependent      Node     @relation("DependencyDependents", fields: [dependentId], references: [id], onDelete: Cascade)
  dependency     Node     @relation("DependencyDependencies", fields: [dependencyId], references: [id], onDelete: Cascade)

  @@unique([dependentId, dependencyId])

  @@schema("stratum")
}

model Attachment {
  id          String    @id @default(cuid())
  nodeId      String
  url         String
  filename    String
  mimeType    String
  size        Int
  metadata    Json?
  createdAt   DateTime  @default(now())

  node        Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@schema("stratum")
}

model Comment {
  id          String    @id @default(cuid())
  nodeId      String
  authorId    String
  body        String    @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  metadata    Json?
  notifyResponsible Boolean  @default(true)
  notifyAccountable Boolean  @default(true)
  notifyConsulted   Boolean  @default(true)
  notifyInformed    Boolean  @default(true)
  notifyProject     Boolean  @default(false)
  notifySubProject  Boolean  @default(false)
  mentions          String[] @default([])

  node        Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@schema("stratum")
}

model AutomationRule {
  id          String    @id @default(cuid())
  teamId      String
  name        String
  trigger     String
  action      String
  config      Json?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@schema("stratum")
}


enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED

  @@schema("stratum")
}

enum NodeShareInvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED

  @@schema("stratum")
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  revokedAt   DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])

  @@schema("stratum")
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])

  @@schema("stratum")
}

model Invitation {
  id          String            @id @default(cuid())
  email       String
  teamId      String
  invitedById String
  status      InvitationStatus  @default(PENDING)
  tokenHash   String            @unique
  expiresAt   DateTime
  respondedAt DateTime?
  createdAt   DateTime          @default(now())

  team        Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  invitedBy   User              @relation("UserInvitations", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([teamId])

  @@schema("stratum")
}

model NodeShareInvitation {
  id             String                     @id @default(cuid())
  nodeId         String
  inviterId      String
  inviteeEmail   String
  inviteeUserId  String?
  status         NodeShareInvitationStatus  @default(PENDING)
  expiresAt      DateTime
  respondedAt    DateTime?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  node           Node                       @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  inviter        User                       @relation("NodeShareInvitationsSent", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee        User?                      @relation("NodeShareInvitationsReceived", fields: [inviteeUserId], references: [id], onDelete: SetNull)

  @@unique([nodeId, inviteeEmail])
  @@index([inviteeEmail])
  @@index([inviteeUserId])
  @@index([status])

  @@schema("stratum")
}

model UserSettings {
  userId      String   @id
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("stratum")
}

model QuickNote {
  id          String        @id @default(cuid())
  userId      String
  text        String
  type        QuickNoteType
  kanbanId    String?
  kanbanName  String?
  createdAt   DateTime      @default(now())
  treatedAt   DateTime?
  reminderAt  DateTime?

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  kanban      Board?        @relation(fields: [kanbanId], references: [id], onDelete: SetNull)

  @@index([userId, treatedAt])
  @@index([kanbanId])

  @@schema("stratum")
}

model BoardDailySnapshot {
  id         String   @id @default(cuid())
  boardId    String
  dateUTC    DateTime
  backlog    Int      @default(0)
  inProgress Int      @default(0)
  blocked    Int      @default(0)
  done       Int      @default(0)
  total      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([boardId, dateUTC])
  @@index([dateUTC])

  @@schema("stratum")
}

model SharedNodePlacement {
  id         String   @id @default(cuid())
  nodeId     String
  userId     String
  columnId   String
  position   Float    @default(0)
  archivedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  node       Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  column     Column   @relation(fields: [columnId], references: [id], onDelete: Cascade)

  @@unique([nodeId, userId])
  @@index([userId])
  @@index([nodeId])
  @@index([columnId])

  @@schema("stratum")
}

model ActivityLog {
  id         String       @id @default(cuid())
  nodeId     String
  userId     String
  type       ActivityType
  metadata   Json?
  createdAt  DateTime     @default(now())

  node       Node         @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([nodeId, createdAt])
  @@index([userId])
  @@index([type])

  @@schema("stratum")
}

model WorkspaceAiConfig {
  id                  String           @id @default(cuid())
  workspaceId         String           @unique
  aiEnabled           Boolean          @default(false)
  aiLevel             WorkspaceAiLevel @default(OFF)
  llmProvider         String?
  llmModel            String?
  llmBaseUrl          String?
  embeddingProvider   String?
  embeddingModel      String?
  temperature         Decimal?         @db.Decimal(3, 2)
  topP                Decimal?         @db.Decimal(3, 2)
  maxTokens           Int?
  systemPromptVersion String?
  maxEntitiesPerProposal Int?          @default(50)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@schema("stratum")
}

model WorkspaceAiQuota {
  id                     String   @id @default(cuid())
  workspaceId            String   @unique
  monthlyTokenBudget     BigInt?
  monthlyEmbeddingBudget BigInt?
  maxRequestsPerMinute   Int      @default(60)
  hardStopOnBudget       Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@schema("stratum")
}

model AiUsageLog {
  id               String   @id @default(cuid())
  workspaceId      String
  userId           String
  provider         String
  model            String
  feature          String
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  embeddingTokens  Int      @default(0)
  estimatedCostUsd Decimal? @db.Decimal(12, 6)
  createdAt        DateTime @default(now())

  @@index([workspaceId, createdAt(sort: Desc)])

  @@schema("stratum")
}

model Proposal {
  id                  String         @id @default(cuid())
  workspaceId         String
  intent              String?        @db.Text
  status              ProposalStatus @default(DRAFT)
  confidenceScore     Decimal?       @db.Decimal(4, 3)
  determinismScore    String?
  expectedPreconditions Json?
  idempotencyKey      String?
  requestedByUserId   String?
  approvedByUserId    String?
  rejectedByUserId    String?
  rejectionReason     String?        @db.Text
  alternativesCount   Int            @default(1)
  selectedAlternativeNo Int?
  explanation         Json?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  approvedAt          DateTime?
  rejectedAt          DateTime?
  appliedAt           DateTime?

  actions             ProposalAction[]
  events              EventLog[]
  feedbacks           ProposalFeedback[]
  proposalExplanation ProposalExplanation?

  @@unique([workspaceId, idempotencyKey])
  @@index([workspaceId, status, createdAt(sort: Desc)])

  @@schema("stratum")
}

model ProposalAction {
  id               String   @id @default(cuid())
  proposalId       String
  alternativeNo    Int      @default(1)
  actionOrder      Int
  actionType       String
  targetEntityType String?
  targetEntityId   String?
  payload          Json
  inversePayload   Json?
  createdAt        DateTime @default(now())

  proposal         Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, alternativeNo, actionOrder])
  @@index([proposalId])

  @@schema("stratum")
}

model EventLog {
  id            String         @id @default(cuid())
  workspaceId   String
  actorType     EventActorType
  actorId       String?
  source        EventSource
  eventType     String
  entityType    String
  entityId      String
  correlationId String?
  proposalId    String?
  payload       Json
  createdAt     DateTime       @default(now())

  proposal      Proposal?      @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([proposalId])
  @@index([entityType, entityId, createdAt(sort: Desc)])

  @@schema("stratum")
}

// ───────────────────────────────────────────────────────────────
// AN-P1-01 — RAG schema
// ───────────────────────────────────────────────────────────────

enum RagDocumentStatus {
  ACTIVE
  STALE
  DELETED

  @@schema("stratum")
}

enum RagIndexJobStatus {
  PENDING
  RUNNING
  DONE
  FAILED

  @@schema("stratum")
}

enum RagIndexJobReason {
  EVENT
  REBUILD
  REPAIR

  @@schema("stratum")
}

model RagDocument {
  id                   String            @id @default(cuid())
  workspaceId          String
  sourceEntityType     String
  sourceEntityId       String
  sourceVersionHash    String
  flattenSchemaVersion String
  title                String            @db.Text
  body                 String            @db.Text
  metadata             Json
  status               RagDocumentStatus @default(ACTIVE)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  chunks               RagChunk[]

  @@unique([workspaceId, sourceEntityType, sourceEntityId, sourceVersionHash])
  @@index([workspaceId, sourceEntityType, sourceEntityId])
  @@index([workspaceId, status])

  @@schema("stratum")
}

model RagChunk {
  id          String   @id @default(cuid())
  documentId  String
  chunkIndex  Int
  text        String   @db.Text
  tokenCount  Int
  checksum    String
  metadata    Json
  createdAt   DateTime @default(now())

  document    RagDocument        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  embeddings  RagEmbeddingRecord[]

  @@unique([documentId, chunkIndex])
  @@index([documentId])

  @@schema("stratum")
}

model RagEmbeddingRecord {
  id        String   @id @default(cuid())
  chunkId   String
  provider  String
  model     String
  dimension Int
  vectorRef String
  checksum  String
  createdAt DateTime @default(now())

  chunk     RagChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@unique([chunkId, provider, model])
  @@index([chunkId])

  @@schema("stratum")
}

model RagIndexJob {
  id               String            @id @default(cuid())
  workspaceId      String
  reason           RagIndexJobReason
  sourceEventId    String?
  sourceEntityType String?
  sourceEntityId   String?
  status           RagIndexJobStatus @default(PENDING)
  retryCount       Int               @default(0)
  errorMessage     String?           @db.Text
  generationId     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([workspaceId, status, createdAt(sort: Desc)])
  @@index([status, createdAt])

  @@schema("stratum")
}

// === AN-P2-06: Object-Oriented Memory Model ===

enum GoalHorizon {
  WEEK
  QUARTER
  YEAR

  @@schema("stratum")
}

enum GoalStatus {
  ACTIVE
  PAUSED
  DONE
  ARCHIVED

  @@schema("stratum")
}

model Goal {
  id              String      @id @default(cuid())
  workspaceId     String
  description     String      @db.Text
  horizon         GoalHorizon
  linkedNodes     Json        @default("[]")
  successMetric   Json        @default("{}")
  confidenceLevel Decimal?    @db.Decimal(4, 3)
  status          GoalStatus  @default(ACTIVE)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([workspaceId, status, horizon])

  @@schema("stratum")
}

// === Dette technique: tables PRD manquantes ===

enum AiPromptType {
  PROPOSAL
  BRIEF
  REFACTOR
  CHAT_SUMMARY

  @@schema("stratum")
}

model AiPromptVersion {
  id              String       @id @default(cuid())
  workspaceId     String
  promptType      AiPromptType
  version         Int
  content         String       @db.Text
  variablesSchema Json         @default("{}")
  isActive        Boolean      @default(false)
  createdByUserId String
  createdAt       DateTime     @default(now())
  activatedAt     DateTime?

  @@unique([workspaceId, promptType, version])
  @@index([workspaceId, promptType, isActive])

  @@schema("stratum")
}

model ProposalFeedback {
  id                   String   @id @default(cuid())
  proposalId           String
  proposal             Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  workspaceId          String
  userId               String
  accepted             Boolean
  modifiedAfterApply   Boolean  @default(false)
  userRating           Int?
  rejectionReason      String?  @db.Text
  createdAt            DateTime @default(now())

  @@unique([proposalId, userId])
  @@index([workspaceId, createdAt(sort: Desc)])

  @@schema("stratum")
}

enum ConversationSessionStatus {
  ACTIVE
  ARCHIVED
  RESET

  @@schema("stratum")
}

model AgentConversationSession {
  id                       String                    @id @default(cuid())
  workspaceId              String
  userId                   String
  boardId                  String?
  focusNodeId              String?
  status                   ConversationSessionStatus @default(ACTIVE)
  tokenBudget              Int                       @default(12000)
  autoSummarizeThreshold   Int                       @default(8000)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  summaries                ConversationSummary[]

  @@index([workspaceId, userId, updatedAt(sort: Desc)])

  @@schema("stratum")
}

model ConversationSummary {
  id                   String                    @id @default(cuid())
  sessionId            String
  session              AgentConversationSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  summaryVersion       Int
  summaryText          String                    @db.Text
  coveredMessageCount  Int
  promptVersionId      String?
  createdAt            DateTime                  @default(now())

  @@unique([sessionId, summaryVersion])

  @@schema("stratum")
}

enum BusinessRuleExecResult {
  PASS
  FAIL
  ERROR

  @@schema("stratum")
}

enum BusinessRuleExecSource {
  MANUAL_API
  PROPOSAL_APPLY
  AGENT_PRECHECK
  SCHEDULER

  @@schema("stratum")
}

model BusinessRuleVersion {
  id              String   @id @default(cuid())
  workspaceId     String
  ruleSetName     String
  version         Int
  rulesJson       Json
  isActive        Boolean  @default(false)
  createdByUserId String
  createdAt       DateTime @default(now())
  activatedAt     DateTime?

  executionLogs   BusinessRuleExecutionLog[]

  @@unique([workspaceId, ruleSetName, version])
  @@index([workspaceId, ruleSetName, isActive])

  @@schema("stratum")
}

model BusinessRuleExecutionLog {
  id              String                   @id @default(cuid())
  workspaceId     String
  ruleVersionId   String
  ruleVersion     BusinessRuleVersion      @relation(fields: [ruleVersionId], references: [id])
  source          BusinessRuleExecSource
  correlationId   String?
  entityType      String?
  entityId        String?
  actionType      String?
  result          BusinessRuleExecResult
  violations      Json?
  durationMs      Int?
  createdAt       DateTime                 @default(now())

  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([correlationId])

  @@schema("stratum")
}

model ProposalExplanation {
  id                String   @id @default(cuid())
  proposalId        String   @unique
  proposal          Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  reasoningSummary  String   @db.Text
  referencedEntities Json    @default("[]")
  ragDocIdsUsed     Json     @default("[]")
  confidenceScore   Decimal? @db.Decimal(4, 3)
  createdAt         DateTime @default(now())

  @@index([proposalId])

  @@schema("stratum")
}

// === AN-P2-04: Webhooks sortants (persistés) ===

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  DEAD_LETTER

  @@schema("stratum")
}

model Webhook {
  id            String   @id @default(cuid())
  workspaceId   String
  url           String
  secretHash    String
  eventTypes    String[]
  enabled       Boolean  @default(true)
  description   String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  deliveries    WebhookDelivery[]

  @@index([workspaceId, enabled])

  @@schema("stratum")
}

model WebhookDelivery {
  id            String                @id @default(cuid())
  webhookId     String
  webhook       Webhook               @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  eventId       String
  eventType     String
  status        WebhookDeliveryStatus @default(PENDING)
  httpStatus    Int?
  errorMessage  String?               @db.Text
  attempt       Int                   @default(1)
  nextRetryAt   DateTime?
  deliveredAt   DateTime?
  createdAt     DateTime              @default(now())

  @@index([webhookId, createdAt(sort: Desc)])
  @@index([status, nextRetryAt])

  @@schema("stratum")
}

// === AN-P2-05: Scheduler jobs (persistés) ===

enum SchedulerJobType {
  MORNING_BRIEF
  WEEKLY_REPORT
  STAGNATION_CHECK
  WIP_OVERLOAD_CHECK

  @@schema("stratum")
}

model SchedulerJob {
  id              String           @id @default(cuid())
  workspaceId     String
  jobType         SchedulerJobType
  cronExpression  String
  enabled         Boolean          @default(true)
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  errorCount      Int              @default(0)
  lastErrorMessage String?         @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([workspaceId, jobType])
  @@index([enabled, nextRunAt])

  @@schema("stratum")
}
