generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["stratum"]
  // Connection URL is configured in prisma.config.ts (Prisma ORM v7+)
}

enum MembershipStatus {
  INVITED
  ACTIVE
  SUSPENDED
}


enum ColumnBehaviorKey {
  BACKLOG
  IN_PROGRESS
  BLOCKED
  DONE
  CUSTOM
}

enum Priority {
  NONE
  CRITICAL
  HIGH
  MEDIUM
  LOW
  LOWEST
}

enum Effort {
  UNDER2MIN
  XS
  S
  M
  L
  XL
  XXL
}

enum ActivityType {
  SHARE_INVITE_CREATED
  SHARE_INVITE_ACCEPTED
  SHARE_INVITE_DECLINED
  SHARE_INVITE_EXPIRED
  SHARE_LINK_REMOVED
  KANBAN_SOFT_DELETED
  KANBAN_RESTORED
  KANBAN_MOVED
  KANBAN_MOVE_REFUSED
  KANBAN_BECAME_SHARED
  NODE_CREATED
  NODE_UPDATED
  NODE_MOVED
  NODE_DELETED
  NODE_ARCHIVED
  NODE_RESTORED
  NODE_SNOOZED
  NODE_UNSNOOZED
  COLLABORATOR_ADDED
  COLLABORATOR_REMOVED
  INVITATION_SENT
  INVITATION_ACCEPTED
  INVITATION_DECLINED
  COMMENT_ADDED
  DESCRIPTION_UPDATED
  TITLE_UPDATED
  DUE_DATE_UPDATED
  PRIORITY_UPDATED
  EFFORT_UPDATED
  TAGS_UPDATED
  ASSIGNEES_UPDATED
  MOVED_TO_BOARD
  PROGRESS_UPDATED
  BLOCKED_STATUS_CHANGED
  RACI_UPDATED
}

enum QuickNoteType {
  NOTE
  DONE
  WAITING
}

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  passwordHash    String?
  displayName     String
  locale          String        @default("en-US")
  avatarUrl       String?
  bio             String?
  preferences     Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  memberships     Membership[]
  assignedNodes   NodeAssignment[]
  comments        Comment[]
  refreshTokens    RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  invitationsSent  Invitation[] @relation("UserInvitations")
  settings        UserSettings?
  ownedBoards     Board[]       @relation("UserOwnedBoards")
  nodeShareInvitationsSent NodeShareInvitation[] @relation("NodeShareInvitationsSent")
  nodeShareInvitationsReceived NodeShareInvitation[] @relation("NodeShareInvitationsReceived")
  sharedNodePlacements SharedNodePlacement[]
  activityLogs    ActivityLog[]
  quickNotes      QuickNote[]
}

model Team {
  id              String           @id @default(cuid())
  name            String
  slug            String?          @unique
  description     String?
  settings        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  memberships     Membership[]
  nodes           Node[]
  automationRules AutomationRule[]
  invitations     Invitation[]
  isPersonal      Boolean          @default(false)
}

model Membership {
  id         String            @id @default(cuid())
  userId     String
  teamId     String
  title      String?
  status     MembershipStatus  @default(ACTIVE)
  metadata   Json?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  team       Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
}

model Node {
  id              String            @id @default(cuid())
  teamId          String
  workspaceId     String
  parentId        String?
  columnId        String?
  title           String
  description     String?           @db.Text
  shortId         Int               @unique @default(autoincrement())
  path            String
  depth           Int               @default(0)
  position        Float             @default(0)
  progress        Int               @default(0)
  priority        Priority          @default(NONE)
  effort          Effort?
  tags            String[]          @default([])
  blockedReason               String?           @db.Text
  blockedReminderEmails       String[]          @default([])
  blockedReminderIntervalDays Int?
  blockedReminderLastSentAt   DateTime?
  blockedExpectedUnblockAt    DateTime?
  blockedSince                DateTime?
  isBlockResolved             Boolean           @default(false)
  statusMetadata  Json?
  metadata        Json?
  dueAt           DateTime?
  startAt         DateTime?
  archivedAt      DateTime?
  createdById     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  team            Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  parent          Node?             @relation("NodeToNode", fields: [parentId], references: [id], onDelete: Cascade)
  children        Node[]            @relation("NodeToNode")
  board           Board?
  column          Column?           @relation(fields: [columnId], references: [id])
  assignments     NodeAssignment[]
  dependencies    Dependency[]      @relation("DependencyDependents")
  dependents      Dependency[]      @relation("DependencyDependencies")
  attachments     Attachment[]
  comments        Comment[]
  shareInvitations NodeShareInvitation[]
  sharedPlacements SharedNodePlacement[]
  activityLogs    ActivityLog[]

  @@index([workspaceId])
}

model Board {
  id              String            @id @default(cuid())
  nodeId          String            @unique
  layout          Json?
  themeOverride   Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ownerUserId     String?
  isPersonal      Boolean           @default(false)

  node            Node              @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  columns         Column[]
  dailySnapshots  BoardDailySnapshot[]
  owner           User?             @relation("UserOwnedBoards", fields: [ownerUserId], references: [id], onDelete: SetNull)
  quickNotes      QuickNote[]
}

model Column {
  id              String             @id @default(cuid())
  boardId         String
  behaviorId      String
  name            String
  position        Int
  wipLimit        Int?
  slaConfig       Json?
  settings        Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  board           Board              @relation(fields: [boardId], references: [id], onDelete: Cascade)
  behavior        ColumnBehavior     @relation(fields: [behaviorId], references: [id], onDelete: Restrict)
  nodes           Node[]
  sharedNodePlacements SharedNodePlacement[]
}

model ColumnBehavior {
  id        String            @id @default(cuid())
  key       ColumnBehaviorKey
  label     String
  metadata  Json?
  color     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  columns   Column[]
}

model NodeAssignment {
  id          String    @id @default(cuid())
  nodeId      String
  userId      String
  role        String?
  assignedAt  DateTime  @default(now())

  node        Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Checklist & ChecklistItem supprimés (migration unifiée vers enfants)

model Dependency {
  id             String   @id @default(cuid())
  dependentId    String
  dependencyId   String
  type           String   @default("finish-to-start")
  lag            Int      @default(0)

  dependent      Node     @relation("DependencyDependents", fields: [dependentId], references: [id], onDelete: Cascade)
  dependency     Node     @relation("DependencyDependencies", fields: [dependencyId], references: [id], onDelete: Cascade)

  @@unique([dependentId, dependencyId])
}

model Attachment {
  id          String    @id @default(cuid())
  nodeId      String
  url         String
  filename    String
  mimeType    String
  size        Int
  metadata    Json?
  createdAt   DateTime  @default(now())

  node        Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
}

model Comment {
  id          String    @id @default(cuid())
  nodeId      String
  authorId    String
  body        String    @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  metadata    Json?
  notifyResponsible Boolean  @default(true)
  notifyAccountable Boolean  @default(true)
  notifyConsulted   Boolean  @default(true)
  notifyInformed    Boolean  @default(true)
  notifyProject     Boolean  @default(false)
  notifySubProject  Boolean  @default(false)
  mentions          String[] @default([])

  node        Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model AutomationRule {
  id          String    @id @default(cuid())
  teamId      String
  name        String
  trigger     String
  action      String
  config      Json?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
}


enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum NodeShareInvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  revokedAt   DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Invitation {
  id          String            @id @default(cuid())
  email       String
  teamId      String
  invitedById String
  status      InvitationStatus  @default(PENDING)
  tokenHash   String            @unique
  expiresAt   DateTime
  respondedAt DateTime?
  createdAt   DateTime          @default(now())

  team        Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  invitedBy   User              @relation("UserInvitations", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([teamId])
}

model NodeShareInvitation {
  id             String                     @id @default(cuid())
  nodeId         String
  inviterId      String
  inviteeEmail   String
  inviteeUserId  String?
  status         NodeShareInvitationStatus  @default(PENDING)
  expiresAt      DateTime
  respondedAt    DateTime?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  node           Node                       @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  inviter        User                       @relation("NodeShareInvitationsSent", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee        User?                      @relation("NodeShareInvitationsReceived", fields: [inviteeUserId], references: [id], onDelete: SetNull)

  @@unique([nodeId, inviteeEmail])
  @@index([inviteeEmail])
  @@index([inviteeUserId])
  @@index([status])
}

model UserSettings {
  userId      String   @id
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QuickNote {
  id          String        @id @default(cuid())
  userId      String
  text        String
  type        QuickNoteType
  kanbanId    String?
  kanbanName  String?
  createdAt   DateTime      @default(now())
  treatedAt   DateTime?
  reminderAt  DateTime?

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  kanban      Board?        @relation(fields: [kanbanId], references: [id], onDelete: SetNull)

  @@index([userId, treatedAt])
  @@index([kanbanId])
}

model BoardDailySnapshot {
  id         String   @id @default(cuid())
  boardId    String
  dateUTC    DateTime
  backlog    Int      @default(0)
  inProgress Int      @default(0)
  blocked    Int      @default(0)
  done       Int      @default(0)
  total      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([boardId, dateUTC])
  @@index([dateUTC])
}

model SharedNodePlacement {
  id         String   @id @default(cuid())
  nodeId     String
  userId     String
  columnId   String
  position   Float    @default(0)
  archivedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  node       Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  column     Column   @relation(fields: [columnId], references: [id], onDelete: Cascade)

  @@unique([nodeId, userId])
  @@index([userId])
  @@index([nodeId])
  @@index([columnId])
}

model ActivityLog {
  id         String       @id @default(cuid())
  nodeId     String
  userId     String
  type       ActivityType
  metadata   Json?
  createdAt  DateTime     @default(now())

  node       Node         @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([nodeId, createdAt])
  @@index([userId])
  @@index([type])
}
