# Documentation d'exploitation — Public Agent API (P2-01)

## 1. Activation

La Public Agent API est contrôlée par deux variables d'environnement :

| Variable | Type | Requis | Description |
|---|---|---|---|
| `AGENT_PUBLIC_API_ENABLED` | `"true"` / `"false"` | Oui | Active/désactive la Public Agent API |
| `AGENT_PUBLIC_TOKENS` | JSON (array) | Oui si activé | Configuration des tokens d'accès |

Pour activer :

```bash
AGENT_PUBLIC_API_ENABLED=true
AGENT_PUBLIC_TOKENS='[{"id":"tok_001","token":"sk_prod_xxxx","workspaceId":"ws_abc","scopes":["agent:command","agent:chat"],"maxRequestsPerMinute":60,"enabled":true}]'
```

## 2. Format `AGENT_PUBLIC_TOKENS`

Le JSON est un tableau d'objets token, chacun avec les champs suivants :

```json
[
  {
    "id": "tok_001",
    "token": "sk_prod_<random_64_chars>",
    "workspaceId": "clxxxxxxxxxxxxxxxxx",
    "scopes": ["agent:command", "agent:chat"],
    "maxRequestsPerMinute": 60,
    "enabled": true
  }
]
```

| Champ | Type | Obligatoire | Description |
|---|---|---|---|
| `id` | `string` | Oui | Identifiant unique du token (pour les logs) |
| `token` | `string` | Oui | Secret du token — ne sera jamais stocké en clair (hashé SHA-256 au démarrage) |
| `workspaceId` | `string` | Oui | ID du workspace autorisé pour ce token |
| `scopes` | `string[]` | Oui | Scopes autorisés : `agent:command` et/ou `agent:chat` |
| `maxRequestsPerMinute` | `number` | Non | Rate limit par token (défaut : 60/min) |
| `enabled` | `boolean` | Non | Permet de désactiver un token sans le supprimer (défaut : `true`) |

### Scopes disponibles

- **`agent:command`** — accès aux endpoints `/public/command`, `/public/workspaces/:id/events/stream`, `/public/workspaces/:id/webhooks`
- **`agent:chat`** — accès à l'endpoint `/public/chat`

## 3. Génération d'un token sécurisé

```bash
# Générer un token aléatoire de 64 caractères
openssl rand -base64 48 | tr -d '\n' | head -c 64
```

Recommandations :
- Utiliser au minimum 48 caractères aléatoires
- Ne jamais réutiliser un token entre environnements (staging ≠ production)
- Ne jamais committer de tokens dans le code source

## 4. Rotation de token

### Procédure de rotation sans interruption de service

1. **Ajouter le nouveau token** à côté de l'ancien dans `AGENT_PUBLIC_TOKENS` :
```json
[
  {"id":"tok_001","token":"ancien_token","workspaceId":"ws_abc","scopes":["agent:command","agent:chat"],"enabled":true},
  {"id":"tok_002","token":"nouveau_token","workspaceId":"ws_abc","scopes":["agent:command","agent:chat"],"enabled":true}
]
```

2. **Redéployer** le backend pour charger les deux tokens.

3. **Mettre à jour les clients** pour utiliser `tok_002` (le nouveau token).

4. **Désactiver l'ancien token** en mettant `"enabled": false` ou en le supprimant :
```json
[
  {"id":"tok_002","token":"nouveau_token","workspaceId":"ws_abc","scopes":["agent:command","agent:chat"],"enabled":true}
]
```

5. **Redéployer** une dernière fois.

## 5. Rate limiting

Le rate limiting est appliqué **par token**, en mémoire, avec une fenêtre glissante de 1 minute.

- Défaut : **60 requêtes/minute** par token
- Configurable via `maxRequestsPerMinute` dans la configuration du token
- En cas de dépassement : `HTTP 429 Too Many Requests`

```json
{
  "code": "PUBLIC_AGENT_RATE_LIMIT_EXCEEDED",
  "message": "Rate limit exceeded (60 requests per minute)"
}
```

## 6. Codes d'erreur

| Code HTTP | Code erreur | Cause | Action |
|---|---|---|---|
| 403 | `FEATURE_DISABLED` | `AGENT_PUBLIC_API_ENABLED ≠ true` | Activer la feature |
| 401 | `PUBLIC_AGENT_TOKEN_MISSING` | Header `Authorization` absent | Ajouter `Authorization: Bearer <token>` |
| 401 | `PUBLIC_AGENT_TOKEN_INVALID` | Token inconnu ou `enabled: false` | Vérifier le token |
| 403 | `PUBLIC_AGENT_SCOPE_WORKSPACE_MISMATCH` | Token pas autorisé pour ce workspace | Vérifier `workspaceId` du token |
| 403 | `PUBLIC_AGENT_SCOPE_MISSING` | Scope manquant | Ajouter le scope requis au token |
| 429 | `PUBLIC_AGENT_RATE_LIMIT_EXCEEDED` | Trop de requêtes | Réduire le débit ou augmenter `maxRequestsPerMinute` |

## 7. Endpoints publics

| Méthode | Endpoint | Scope requis | Description |
|---|---|---|---|
| `POST` | `/api/v1/public/command` | `agent:command` | Créer une proposition agent |
| `POST` | `/api/v1/public/chat` | `agent:chat` | Chat avec l'agent |
| `GET` | `/api/v1/public/workspaces/:id/events/stream` | `agent:command` | Flux d'événements (curseur) |
| `POST` | `/api/v1/public/workspaces/:id/webhooks` | `agent:command` | Créer un webhook sortant |
| `GET` | `/api/v1/public/workspaces/:id/webhooks` | `agent:command` | Lister les webhooks |
| `DELETE` | `/api/v1/public/workspaces/:id/webhooks/:whId` | `agent:command` | Supprimer un webhook |

### Exemple d'appel

```bash
curl -X POST https://stratum.example.com/api/v1/public/command \
  -H "Authorization: Bearer sk_prod_xxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "workspaceId": "clxxxxxxxxxxxxxxxxx",
    "intent": "Déplace la tâche Design vers Done"
  }'
```

## 8. Observabilité et monitoring

### Événements émis dans `event_log`

| eventType | Source | Description |
|---|---|---|
| `AGENT_COMMAND_DRAFT_CREATED` | `API` | Commande reçue via API publique |
| `AGENT_CHAT_RESPONSE_GENERATED` | `API` | Chat reçu via API publique |
| `CONNECTOR_INBOUND_RECEIVED` | `API` | Message reçu via connecteur |

### Alertes recommandées

1. **`PUBLIC_AGENT_RATE_LIMIT_EXCEEDED`** — alerter si un token dépasse régulièrement le rate limit → peut indiquer un abus ou un bug côté client.

2. **`PUBLIC_AGENT_TOKEN_INVALID`** — alerter sur les tentatives d'accès avec des tokens invalides → peut indiquer une compromission ou un scan.

3. **`PUBLIC_AGENT_SCOPE_MISSING`** — alerter si fréquent → peut indiquer une misconfiguration côté client.

### Requête de monitoring (SQL)

```sql
-- Nombre d'appels API publics par token et par jour
SELECT
  DATE_TRUNC('day', "createdAt") AS day,
  payload->>'isPublicApi' AS is_public,
  "actorId" AS token,
  COUNT(*) AS call_count
FROM "stratum"."EventLog"
WHERE "source" = 'API'
  AND "createdAt" > NOW() - INTERVAL '7 days'
GROUP BY 1, 2, 3
ORDER BY 1 DESC, 4 DESC;
```

## 9. Kill-switch

En cas d'incident, l'agent peut être désactivé globalement ou par workspace via le kill-switch :

```bash
# Désactiver l'agent pour un workspace spécifique
curl -X POST https://stratum.example.com/api/v1/workspaces/<workspaceId>/agent/kill-switch \
  -H "Authorization: Bearer <jwt_admin>" \
  -d '{"enabled": false}'
```

Le kill-switch est vérifié à chaque requête, y compris les requêtes de l'API publique. Les appels seront rejetés avec `HTTP 403 / AGENT_KILLED`.
